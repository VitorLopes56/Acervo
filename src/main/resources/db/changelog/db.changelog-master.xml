<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
            http://www.liquibase.org/xml/ns/dbchangelog
            http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.4.xsd">

    <changeSet id="1-create-schema" author="assistant" dbms="mysql">
        <sql>CREATE DATABASE IF NOT EXISTS biblioteca CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;</sql>
    </changeSet>

    <changeSet id="2-create-table-usuarios" author="assistant">
        <createTable tableName="usuarios">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="username" type="VARCHAR(100)"/>
            <column name="password" type="VARCHAR(255)"/>
            <column name="role" type="VARCHAR(50)"/>
            <column name="nome" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>

    <changeSet id="3-create-table-cliente" author="assistant">
        <createTable tableName="cliente">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="nome" type="VARCHAR(255)"/>
            <column name="cpf" type="VARCHAR(20)"/>
            <column name="matricula" type="VARCHAR(50)"/>
            <column name="endereco" type="VARCHAR(255)"/>
            <column name="telefone" type="VARCHAR(50)"/>
            <column name="email" type="VARCHAR(150)"/>
            <column name="data_cadastro" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
    </changeSet>

    <changeSet id="4-create-table-livro" author="assistant">
        <createTable tableName="livro">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="titulo" type="VARCHAR(255)"/>
            <column name="autor" type="VARCHAR(255)"/>
            <column name="codigo" type="VARCHAR(100)"/>
            <column name="categoria" type="VARCHAR(100)"/>
            <column name="ano_publicacao" type="INT"/>
            <column name="quantidade" type="INT" defaultValueNumeric="1"/>
        </createTable>
    </changeSet>

    <changeSet id="5-create-table-estoque" author="assistant">
        <createTable tableName="estoque">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="livro_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="quantidade_total" type="INT"/>
            <column name="quantidade_emprestada" type="INT" defaultValueNumeric="0"/>
        </createTable>
        <addForeignKeyConstraint baseTableName="estoque"
                                 baseColumnNames="livro_id"
                                 referencedTableName="livro"
                                 referencedColumnNames="id"
                                 constraintName="fk_estoque_livro"/>
    </changeSet>

    <changeSet id="6-create-table-emprestimo" author="assistant">
        <createTable tableName="emprestimo">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="cliente_id" type="BIGINT"/>
            <column name="livro_id" type="BIGINT"/>
            <column name="data_emprestimo" type="DATE"/>
            <column name="data_devolucao" type="DATE"/>
            <column name="status" type="VARCHAR(50)"/>
        </createTable>

        <addForeignKeyConstraint baseTableName="emprestimo"
                                 baseColumnNames="cliente_id"
                                 referencedTableName="cliente"
                                 referencedColumnNames="id"
                                 constraintName="fk_emprestimo_cliente"/>
        <addForeignKeyConstraint baseTableName="emprestimo"
                                 baseColumnNames="livro_id"
                                 referencedTableName="livro"
                                 referencedColumnNames="id"
                                 constraintName="fk_emprestimo_livro"/>
    </changeSet>

    <changeSet id="7-insert-default-users" author="assistant">
        <insert tableName="usuarios">
            <column name="username" value="admin"/>
            <column name="password" value="admin"/>
            <column name="role" value="FUNCIONARIO"/>
            <column name="nome" value="Administrador"/>
        </insert>

        <insert tableName="usuarios">
            <column name="username" value="cliente"/>
            <column name="password" value="admin"/>
            <column name="role" value="CLIENTE"/>
            <column name="nome" value="Cliente Padrão"/>
        </insert>
    </changeSet>

    <changeSet id="8-insert-sample-data" author="assistant">
        <insert tableName="cliente">
            <column name="nome" value="João Silva"/>
            <column name="cpf" value="000.000.000-00"/>
            <column name="matricula" value="MATR-001"/>
            <column name="endereco" value="Rua A, 123"/>
            <column name="telefone" value="(31) 99999-0000"/>
            <column name="email" value="joao@example.com"/>
        </insert>

        <insert tableName="livro">
            <column name="titulo" value="Introdução à Programação"/>
            <column name="autor" value="Autor Exemplo"/>
            <column name="codigo" value="LIV-0001"/>
            <column name="categoria" value="Informática"/>
            <column name="ano_publicacao" valueNumeric="2020"/>
            <column name="quantidade" valueNumeric="3"/>
        </insert>

        <insert tableName="estoque">
            <column name="livro_id" valueNumeric="1"/>
            <column name="quantidade_total" valueNumeric="3"/>
            <column name="quantidade_emprestada" valueNumeric="0"/>
        </insert>
    </changeSet>

</databaseChangeLog>
